# Yule Pauperism Data

```{r}
library("tidyverse")
library("viridis")
library("broom")
```


The Yule Pauperism data is included in the package **datums** at [jrnold/datums](https://github.com/jrnold/datums).

@Yule1899a was the published example multiple regression analysis in its modern form.[^yule]

Yule wrote this paper to analyze the effect of policy changes and implementation on pauperism (poor receiving benefits) in England.
under the [https://en.wikipedia.org/wiki/English_Poor_Laws](Poor Laws).
In 1834, a [new poor law](https://en.wikipedia.org/wiki/Poor_Law_Amendment_Act_1834) was passed that established a national welfare system in England and Wales. 
The New Poor Law created new administrative districts, Poor Law Unions, to adminster the law.
Most importantly, it attempted to standardize the provision of aid to the poor. 
There were two types of aid provided: in-relief, aid provided to paupers in workhouses where
they resided, and out-relief, aid provided to paupers residing at home.
The New Poor Law wanted to decrease in-relief and increase out-relief in the belief
that out-relief, in particular the quality of life in workhouses, was a deterrence to poverty and an encouragement for the poor to work harder to avoid poverty.


[^yule]: See @Stigler2016a and @Stigler1990a for a discussion.

The data in **datums** is 

It consists of two datasets: `pauperism_plu` contains data on the Poor Law Unions,
while `pauperism_year` has the PLU, year as the unit of observation and contains
data on the levels of pauperism in 1871, 1881, and 1891 in each PLU.

```{r message=FALSE}
library("tidyverse")
# install_github/jrnold
pauperism_plu <- datums::pauperism_plu
pauperism_year <- datums::pauperism_year
```

```{r results='hide'}
glimpse(pauperism_year)
```

Instead of taking differences, or percentages. 
Yule worked with "percent ratio differences",
$100 \times x_t / x_{t - 1}$, because he did not want to work with negative signs, presumably a concern at the because he was doing arithmetic by hand and this would make calculations more tedious or error-prone.
```{r}
pctratiodiff <- function(x) {
  z <- 100 * (x / lag(x))
  z[is.infinite(z)] <- NA_real_
  z
}
```

```{r}
pauperism <-
  pauperism_year %>%
  mutate(Popn65 = F65 + M65,
         Prop65 = Popn65 / Popn,
         year = as.integer(year)) %>%
  arrange(ID, year) %>%
  group_by(ID) %>%
  mutate(Prop65_diff = pctratiodiff(Prop65)) %>%
  left_join(pauperism_plu, by = "ID") %>%
  filter(Type != "NaN") %>%
  ungroup()
```

Table 1. of pauperism
```{r}
pauperism %>% 
  filter(year >= 1881) %>%
  select(ID, year, Type, paupratiodiff, outratiodiff, Prop65_diff, popratiodiff) %>%
  drop_na() %>%
  count(year, Type)
```

The number of districts is different, but I'm not sure why.

Table 2: Metropolitan Group, 1871-1881
```{r results = 'asis'}
filter(pauperism, Type == "Metropolitan") %>%
  filter(year == 1881) %>%
  select(ID, Union, paupratiodiff, outratiodiff, Prop65_diff, popratiodiff) %>%
  arrange(ID) %>%
  ungroup() %>%
  select(-ID) %>%
  knitr::kable()
```

Table 3
```{r}
pauperism %>%
  filter(year >= 1881) %>%
  select(year, Type, paupratiodiff, outratiodiff, Prop65_diff, popratiodiff) %>%
  drop_na() %>%
  gather(variable, value, -year, -Type) %>%
  group_by(year, Type, variable) %>%
  summarise_at(vars(value), funs(mean, sd)) %>%
  knitr::kable()
```

Table 4: Correlations of Percentage Ratios
```{r}
pauperism %>%
  filter(year >= 1881) %>%
  select(year, Type, paupratiodiff, outratiodiff, Prop65_diff, popratiodiff) %>%
  drop_na() %>%
  group_by(year, Type) %>%
  do({
    cor(.[ , c("paupratiodiff", "outratiodiff", "Prop65_diff", "popratiodiff")]) %>%
      tidy() %>%
      gather(.colnames, value, -.rownames) %>%
      filter(.rownames < .colnames) %>%
      unite(variable, .rownames, .colnames) %>%
      spread(variable, value)
  })


```



$$
\begin{aligned}[t]
\Delta\mathtt{Paup} &= \beta_0  \\
          &+ \beta_1 \Delta\mathtt{Out} \\
          &+ \beta_2 \Delta\mathtt{Old} \\
          &+ \beta_3 \Delta\mathtt{Pop} + \varepsilon
\end{aligned}
$$

# Summary Statistics

```{r}
filter(pauperism, year > 1871) %>%
  ungroup() %>%
  count(year, Type)
```


```{r}
filter(pauperism, year > 1871) %>%
  filter(Type != "NaN") %>%
  group_by(year, Type) %>%
  select(paupratiodiff, outratiodiff, Prop65_diff, popratiodiff) %>%
  gather(variable, value, -Type, -year) %>%
  group_by(variable, year, Type) %>%
  summarize(mean = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE)) %>%
  knitr::kable()

```


# Regression

```{r}
lm(pauper ~ outratio, data = pauperism)
lm(pauper ~ year + Type + outratio, data = pauperism)
lm(pauper ~ year + Type + outratio + Prop65 + Popn65, data = pauperism)
lm(pauper ~ Type * (year + outratio + Prop65 + Popn65), data = pauperism)
```

```{r}
ggplot(filter(pauperism, !is.na(pauper), !is.na(outratio)),
       aes(x = outratio, y = pauper)) +
  geom_point(colour = "gray") +
  geom_smooth(method = "lm", colour = "black", se = FALSE) +
  facet_grid(Type ~ year) +
  theme_minimal()
```



```{r}
pauperism_diff <-
  pauperism %>%
  filter(year > 1871) %>%
  mutate(year = as.factor(year)) %>%
  select(ID, Union, Type, year, paupratiodiff, outratiodiff, popratiodiff, Prop65_diff) %>%
  drop_na()

lm(paupratiodiff ~ outratio_diff, data = pauperism_diff)
lm(paupratiodiff ~ Type * year + outratiodiff, data = pauperism_diff)
lm(paupratiodiff ~ Type * year + outratiodiff + popratiodiff + Prop65_diff, data = pauperism_diff)
lm(paupratiodiff ~ (Type * year) * (outratiodiff + Prop65_diff + popratiodiff), data = pauperism_diff)
```


## Summary Statistics

### Outratio

```{r}
ggplot(select(filter(pauperism, !is.na(outratio)),
              outratio, ID, year, Type),
       aes(x = outratio, y = ..density..)) +
  geom_histogram(binwidth = 2) +
  facet_grid(year ~ Type)
```

```{r}
ggplot(select(filter(pauperism, !is.na(outratiodiff)),
              outratiodiff, ID, year, Type),
       aes(x = outratiodiff, y = ..density..)) +
  geom_histogram(binwidth = 20) +
  facet_grid(year ~ Type)
```

## Pauperism

```{r}
ggplot(select(filter(pauperism, !is.na(pauper)),
              pauper, ID, year, Type),
       aes(x = pauper, y = ..density..)) +
  geom_histogram(binwidth = .01) +
  facet_grid(year ~ Type)
```

There appear to be some big outliers in the ratio difference
in pauperism,
```{r}
ggplot(select(filter(pauperism, !is.na(paupratiodiff)),
              paupratiodiff, ID, year, Type),
       aes(x = paupratiodiff, y = ..density..)) +
  geom_histogram(binwidth = 15) +
  facet_grid(year ~ Type)
```


## Specifications

Dependent variable

- proportion paupers
- number paupers
- log(paupers)
- log(proportion paupers)

Controlling for various:

- outratio, inratio
- population
  - number
  - log(number)
  
- proportion 65+
  - proportion
  - number
  - log(number)




```{r}
datums::pauperism_year %>%
  filter(year == 1871) %>%  
  select(outratio, pauper2) %>%
  drop_na() %>%
  ggplot(aes(x = outratio, pauper2)) +
  geom_point() + 
  geom_smooth(method = "lm")
```

```{r}
datums::pauperism_year %>%
  filter(year == 1871) %>%  
  select(outratio, pauper2) %>%
  drop_na() %>%
  cor()
```

Regressions for each year
```{r}
datums::pauperism_year %>%
  group_by(year) %>%
  summarise(mod = list(lm(outratio ~ pauper2, data = .)))
```

```{r}
datums::pauperism_year %>%
  filter(year == 1871) %>%
  select(outratio, pauper2) %>%
  drop_na() %>%
  lm(pauper2 ~ outratio, data = .)
```

```{r}
mod_1871 <-
  datums::pauperism_year %>%
  filter(year == 1871) %>%
  select(outratio, pauper2) %>%
  {lm(pauper2 ~ outratio, data = .)}

ggplot(augment(mod_1871), aes(x = outratio)) +
  geom_ref_line(v = mean(filter(pauperism_year, year == 1871)$outratio, na.rm = TRUE)) +
  geom_point(mapping = aes(y = pauper2, size = .hat, colour = .hat)) +
  geom_path(mapping = aes(y = .fitted)) +
  scale_color_viridis()
  
```

The observations that have the highest weight in determining the fitted values are those furthest from the mean of `X`.


Hat values in multidimensional space:
```{r}
# MDS 
pauperism_mds <-
  pauperism %>%
  filter(year == 1891) %>%
  select(outratiodiff, popratiodiff, Prop65_diff) %>%
  drop_na() %>%
  dist() %>%
  cmdscale() %>%
  tidy()

lm(paupratiodiff ~ outratiodiff + popratiodiff + Prop65_diff,
  data = filter(pauperism, year == 1891)) %>%
  augment() %>%
  bind_cols(pauperism_mds) %>%
  ggplot(aes(x = X1, y = X2, size = .hat, colour = .hat)) +
  geom_ref_line(h = 0) +
  geom_ref_line(v = 0) +
  geom_point()

```


## Multiple regression  anatomy

$$
\beta_k = \frac{\Cov(Y_i, \tilde{X}_{k,i})}{\Var{\tilde{X}_{ki}}}
$$
where $\tidle{X}_{ki}$ is the residual of the regression of $X$ on all the variables other than $K$.


Regress `paupratio` on `Prop65_diff`:
```{r}
pauperism_diff <- select(pauperism, paupratiodiff, outratiodiff, 
                         Prop65_diff, popratiodiff) %>%
  drop_na()
mod_prop65_diff <- lm(paupratiodiff ~ Prop65_diff, data = pauperism_diff)
pauperism_diff$.fitted1 <- fitted(mod_prop65_diff)
pauperism_diff$.resid1 <- residuals(mod_prop65_diff)
```

```{r}
mod_popratiodiff <- lm(.resid1 ~ popratiodiff, data = pauperism_diff)
pauperism_diff$.fitted2 <- fitted(mod_popratiodiff)
pauperism_diff$.resid2 <- residuals(mod_popratiodiff)
```

Regress residuals on `outratiodiff`
```{r}
mod_popratiodiff <- lm(.resid2 ~ outratiodiff, data = pauperism_diff)
pauperism_diff$.fitted3 <- fitted(mod_popratiodiff)
pauperism_diff$.resid3 <- residuals(mod_popratiodiff)
```



- Relationship between the omitted variables $Z$ and $X$
- Relationship between the omitted variable and $Y$

OVB formula. @AngristPischke2014a [p. 70]

- Effect of $X$  in short = Effect of $X$ in long + (Relationship between included and omitted) x effect of omitted in long.
- OVB = (Relationship between $X$ and $Z$) x (effect of $Z$ in long)


